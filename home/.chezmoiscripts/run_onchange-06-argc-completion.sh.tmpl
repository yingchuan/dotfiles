#!/bin/bash
set -euo pipefail

# --- CONFIGURATION ---
ARGC_COMPLETIONS_DIR="$HOME/.config/argc-completions"
ARGC_COMPLETIONS_REPO="https://github.com/sigoden/argc-completions.git"
ARGC_COMPLETIONS_LOCAL="$HOME/.config/argc-completion.local"
OUTPUT_FILE="$HOME/.argc-completion.zsh"

# --- 1. Clone or update argc-completions repo ---
if [ -d "$ARGC_COMPLETIONS_DIR/.git" ]; then
  echo "[chezmoi:argc] Updating argc-completions..."
  git -C "$ARGC_COMPLETIONS_DIR" pull --ff-only
else
  echo "[chezmoi:argc] Cloning argc-completions..."
  git clone "$ARGC_COMPLETIONS_REPO" "$ARGC_COMPLETIONS_DIR"
fi

# --- 2. Generate code block via setup-shell.sh ---
TMP_LOG="$(mktemp)"
(
  cd "$ARGC_COMPLETIONS_DIR"
  ./scripts/setup-shell.sh zsh > "$TMP_LOG" 2>&1
)

echo "[chezmoi:argc] Extracting completion snippet to $OUTPUT_FILE..."
# Extract text between ``` fences
sed -n '/^```$/,/^```$/{/^```$/d;p}' "$TMP_LOG" > "$OUTPUT_FILE"
rm -f "$TMP_LOG"

# --- 3. Append local customization ---
cat >> "$OUTPUT_FILE" <<EOF

# === Custom local completions ===
export ARGC_COMPLETIONS_PATH="\$ARGC_COMPLETIONS_ROOT/completions/linux:\$ARGC_COMPLETIONS_ROOT/completions:$ARGC_COMPLETIONS_LOCAL"

# Combine scripts from all paths
argc_scripts=(
\$(ls -p -1 \
  "\$ARGC_COMPLETIONS_ROOT/completions/linux" \
  "\$ARGC_COMPLETIONS_ROOT/completions" \
  "$ARGC_COMPLETIONS_LOCAL" 2>/dev/null | sed -n 's/\.sh$//p')
)

source <(argc --argc-completions zsh \${argc_scripts[@]})
EOF

echo "[chezmoi:argc] Done. Source $OUTPUT_FILE in your shell config."
