#!/bin/bash
set -euo pipefail

# --- CONFIGURATION ---
ARGC_COMPLETIONS_DIR="$HOME/.config/argc-completions"
ARGC_COMPLETIONS_LOCAL_DIR="$HOME/.config/argc-completions.local"
ARGC_COMPLETIONS_REPO="https://github.com/sigoden/argc-completions.git"
OUTPUT_FILE="$HOME/.argc-completion.zsh"

# --- 1. Clone or update argc-completions repo ---
if [ -d "$ARGC_COMPLETIONS_DIR/.git" ]; then
  echo "[chezmoi:argc] Updating argc-completions..."
  git -C "$ARGC_COMPLETIONS_DIR" pull --ff-only
else
  echo "[chezmoi:argc] Cloning argc-completions..."
  git clone "$ARGC_COMPLETIONS_REPO" "$ARGC_COMPLETIONS_DIR"
fi

# --- 2. Generate code block via setup-shell.sh ---
TMP_LOG="$(mktemp)"
(
  cd "$ARGC_COMPLETIONS_DIR"
  ./scripts/setup-shell.sh zsh > "$TMP_LOG" 2>&1
)

echo "[chezmoi:argc] Extracting completion snippet to $OUTPUT_FILE..."
# Extract text between ``` fences
{ 
  echo "# argc-completions"
  echo "export ARGC_COMPLETIONS_ROOT=\"$ARGC_COMPLETIONS_DIR\""
  echo "export ARGC_COMPLETIONS_PATH=\"$ARGC_COMPLETIONS_DIR/completions/linux:$ARGC_COMPLETIONS_DIR/completions:$ARGC_COMPLETIONS_LOCAL_DIR\""
  echo "export PATH=\"$ARGC_COMPLETIONS_DIR/bin:$PATH\""
  echo "# To add completions for only the specified command, modify next line e.g. argc_scripts=( cargo git )"
  echo -n "argc_scripts=( ";
  ls -p -1 "$ARGC_COMPLETIONS_DIR/completions/linux" \
     "$ARGC_COMPLETIONS_DIR/completions" \
     "$ARGC_COMPLETIONS_LOCAL_DIR" 2>/dev/null \
  | sed -n 's/\.sh\$//p' | xargs echo; 
  echo ")"
  echo "source <(argc --argc-completions zsh \"\\${argc_scripts[@]}\")"
} > "$OUTPUT_FILE"

rm -f "$TMP_LOG"

echo "[chezmoi:argc] Done. Source $OUTPUT_FILE in your shell config."
