#!/bin/bash
set -euo pipefail

# --- CONFIG ---
sudo_cmd="sudo"

# --- System Update & Apt Packages ---
$sudo_cmd apt update
{{ range .ubuntu.apt -}}
$sudo_cmd apt install -yy {{ . }}
{{ end }}

# --- Snap Packages ---
{{ range .ubuntu.snap -}}
$sudo_cmd snap install {{ .instance }} {{ .args }}
{{ end }}

# --- Docker Installation ---
if [ ! -f /etc/apt/keyrings/docker.asc ]; then
  echo "[chezmoi] Installing Docker..."
  $sudo_cmd install -m 0755 -d /etc/apt/keyrings
  $sudo_cmd curl -fsSL https://download.docker.com/linux/ubuntu/gpg -o /etc/apt/keyrings/docker.asc
  $sudo_cmd chmod a+r /etc/apt/keyrings/docker.asc

  echo \
  "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu \
  $(. /etc/os-release && echo "$VERSION_CODENAME") stable" | \
  $sudo_cmd tee /etc/apt/sources.list.d/docker.list > /dev/null

  $sudo_cmd apt-get update
  $sudo_cmd apt-get install -yy docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
  $sudo_cmd usermod -aG docker $USER
  systemctl --user daemon-reexec
  systemctl --user enable --now qdrant-compose.service
fi

# --- Fonts ---
echo "[chezmoi] Installing Nerd Font..."
rm -rf ~/.local/share/fonts
mkdir -p ~/.local/share/fonts
cd ~/.local/share/fonts && curl -fLO https://github.com/ryanoasis/nerd-fonts/raw/HEAD/patched-fonts/DroidSansMono/DroidSansMNerdFont-Regular.otf

# --- LazyGit ---
if [ ! -f "$HOME/go/bin/lazygit" ]; then
  go install github.com/jesseduffield/lazygit@latest
fi

# --- Homebrew ---
if ! command -v brew >/dev/null 2>&1; then
  echo "[chezmoi] Installing Homebrew..."
  /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
  eval "$(brew shellenv)"
  echo 'eval "$(brew shellenv)"' >> ~/.bashrc
else
  echo "Homebrew is already installed."
  eval "$(brew shellenv)"
fi

export HOMEBREW_NO_INSTALL_CLEANUP=true

# --- pipx via Homebrew ---
if ! command -v pipx >/dev/null 2>&1; then
  echo "[chezmoi] Installing pipx via Homebrew..."
  brew install pipx
  pipx ensurepath
fi

# --- pipx Packages ---
pipx install poetry
pipx install ruff uv
pipx install pre-commit
pipx install git+https://github.com/openai/whisper.git
pipx install yt-dlp openai-whisper openai
pipx install aider-chat --python 3.12.10

# --- Yek CLI ---
curl -fsSL https://bodo.run/yek.sh | bash

# --- Perl Neovim ---
cpanm Neovim::Ext

# --- Brew Formulae ---
{{ range .homebrew.formulae -}}
brew reinstall {{ . }}
{{ end }}

# --- Global NPM Packages ---
{{ range .npm.install -}}
npm install -g {{ . }}
{{ end }}

# --- Pyenv Installation ---
PYENV_ROOT="$HOME/.pyenv"
if [ ! -d "$PYENV_ROOT/bin" ]; then
  echo "[chezmoi] Installing pyenv..."
  curl https://pyenv.run | bash
fi

exit 0
