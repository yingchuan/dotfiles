#!/bin/bash
set -euo pipefail

# --- CONFIGURATION ---
PYENV_ROOT="${HOME}/.pyenv"
PYTHON_VERSIONS=("3.13.3" "3.12.10")
VENV_PATH="${HOME}/.config/nvim/nvim-venv"
VENV_NAME="nvim-venv"
NEOVIM_PKG="pynvim"

# --- 1. Ensure pipx and pyenv installed ---
if ! command -v pipx >/dev/null 2>&1; then
    echo "[chezmoi:nvim] Installing pipx..."
    python3 -m ensurepip --upgrade
    python3 -m pip install --user pipx
    python3 -m pipx ensurepath
    export PATH="$HOME/.local/bin:$PATH"
fi

if ! command -v pyenv >/dev/null 2>&1; then
    echo "[chezmoi:nvim] Installing pyenv via pipx..."
    pipx install pyenv
    export PATH="$HOME/.local/bin:$PATH"
fi

# --- 2. Install pyenv-virtualenv ---
if [ ! -d "${PYENV_ROOT}/plugins/pyenv-virtualenv" ]; then
    echo "[chezmoi:nvim] Installing pyenv-virtualenv plugin..."
    git clone https://github.com/pyenv/pyenv-virtualenv.git "${PYENV_ROOT}/plugins/pyenv-virtualenv"
fi

# Init pyenv + virtualenv
export PYENV_ROOT="${PYENV_ROOT}"
export PATH="${PYENV_ROOT}/bin:$PATH"
eval "$(pyenv init -)"
eval "$(pyenv virtualenv-init -)"

# --- 3. Install Python versions ---
for version in "${PYTHON_VERSIONS[@]}"; do
    if ! pyenv versions --bare | grep -qx "$version"; then
        echo "[chezmoi:nvim] Installing Python $version via pyenv..."
        if command -v brew >/dev/null 2>&1; then
            brew unlink pkg-config || true
        fi
        pyenv install "$version"
        if command -v brew >/dev/null 2>&1; then
            brew link pkg-config || true
        fi
    else
        echo "[chezmoi:nvim] Python $version already installed, skipping"
    fi
done

# --- 4. Create virtualenv using 3.13.3 ---
if [ ! -d "${VENV_PATH}" ]; then
    echo "[chezmoi:nvim] Creating virtualenv $VENV_NAME using Python 3.13.3..."
    pyenv virtualenv 3.13.3 "$VENV_NAME"
    mkdir -p "$(dirname "$VENV_PATH")"
    ln -s "${PYENV_ROOT}/versions/${VENV_NAME}" "${VENV_PATH}"
else
    echo "[chezmoi:nvim] Virtualenv already exists at $VENV_PATH"
fi

# --- 5. Install neovim package ---
echo "[chezmoi:nvim] Installing neovim Python package..."
"${VENV_PATH}/bin/pip" install --upgrade pip
"${VENV_PATH}/bin/pip" install "$NEOVIM_PKG"

echo "[chezmoi:nvim] Done."
